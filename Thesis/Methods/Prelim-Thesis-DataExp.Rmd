---
title: "Thesis Code Prelim"
author: "Casey Sakamoto"
date: "5/5/2020"
output: pdf_document
---
For Preliminary Data Analysis and Cleaning
```{r setup, include=FALSE}
# libraries
library(Hmisc)
library(tidyverse)
library(compositions)
library(vegan)
library(lcmm)
# data
BONUS_Species <- read.delim("C:/Users/Casey/Desktop/WorkData/Thesis 2020/BONUS_Species.txt")
```

```{r summaries}
describe(BONUS_Species)
# 22 distinct phyla, 550 last; tons of 0's up to 90th pctl

##### Stack Barchart ######
bonus_cutoff5 = BONUS_Species %>% filter(perc_total > 5)

# position for barchart labels
bonus_cutoff5 = bonus_cutoff5 %>% group_by(last) %>% mutate(pos = cumsum(perc_total) - (0.5)* perc_total)

# stack labels
taxa_sbc_c5 = ggplot(data = bonus_cutoff5,
                     aes(x = month, y = perc_total, fill = last, label = last)) + 
  geom_bar(stat = "identity") + facet_wrap(~Patient)+
  geom_text(size = 3 , position = position_stack(vjust = 0.5)) 

taxa_sbc_c5 = taxa_sbc_c5 + 
  theme_classic()+
  theme(legend.position = "none")+
  labs(title = "Change in Community Composition Within Subjects",
                                 x = "Visit", 
                                 y = "Total Percent of Community")
setwd("D:/Repositories/CUANSCHUTZ/Thesis/Methods")
ggsave("20200505testexpl_sbc.png", plot = taxa_sbc_c5, height = 70, width = 70, limitsize = FALSE)
# ================================================================ #
```

```{r clr}
# each sample identified by molecular id; data in long format 
samples_long = BONUS_Species %>% select(OTU_Name, seq_count, molecular_id)
samples_wide = samples_long %>% spread(key = molecular_id, value = seq_count)

# convert to numeric cells from factor format
matrix.dat = data.matrix(samples_wide[,-1])
rownames(matrix.dat) = samples_wide[,1]

#calculate number of samples
n_samp <- ncol(matrix.dat)
n_samp

#calculate number of taxa
n_org <- nrow(matrix.dat)
n_org

#generate matrix of counts
counts <- matrix.dat
#generate vector of total counts
total <- apply(counts,2,sum)

#define matrices
ra <- matrix (rep(0,n_org*n_samp), n_org,n_samp)
l_ra <- matrix (rep(0,n_org*n_samp), n_org,n_samp)
clr <- matrix (rep(0,n_org*n_samp), n_org,n_samp)
gm <- rep(0,n_samp)
c <- rep(0,n_samp)

for (i in 1:n_samp) {
               #calc weight
               c[i] <- 1/total[i]

               for (j in 1:n_org) {
               #transform counts to relative abundance and add small amount and log transform
               ra[j,i] <- (counts[j,i]+c[i])/(total[i]+c[i]*n_org)
               l_ra[j,i] <- log(ra[j,i])
               }
               #calculate gm
               gm[i]=mean(l_ra[ ,i])
               clr[ ,i] <- l_ra[ ,i] - gm[i]
}


#verify this code gives same result as compositions package
ra2=t(ra)
dat= ilr(acomp(ra2))
dat[1,]
clr[,1]
hist(dat[1,]);hist(clr[,1])

# both clr and ilr look pretty bad w/ so much 0's
```

```{r grouping}
BONUS_Species =  BONUS_Species %>% mutate(taxa_group = case_when(grepl("Veillonella", OTU_Name) ~ "Veillonella",
                                                                 grepl("Streptococcus", OTU_Name) ~ "Streptococcus",
                                                                 grepl("Prevotella", OTU_Name) ~ "Prevotella",
                                                                 TRUE ~ "Other"))

# 92% other; 2.5% Prev; 3.6% Strep, 1.6% Veil
describe(BONUS_Species$taxa_group)

# try a clr/ilr with the grouped
# each sample identified by molecular id; data in long format 
samples_long = BONUS_Species %>% select(taxa_group, seq_count, molecular_id)
# need to compress similar cells
groups_long = samples_long %>% group_by(taxa_group, molecular_id) %>% summarise(seq_count = sum(seq_count))
# convert to wide format  
groups_wide = groups_long %>% spread(key = molecular_id, value = seq_count)

# convert to numeric cells from factor format
matrix.dat = data.matrix(groups_wide[,-1])
# for some reason this isnt working
# rownames(matrix.dat) = groups_wide[,1]

#calculate number of samples
n_samp <- ncol(matrix.dat)
n_samp

#calculate number of taxa
n_org <- nrow(matrix.dat)
n_org

#generate matrix of counts
counts <- matrix.dat
#generate vector of total counts
total <- apply(counts,2,sum)

#define matrices
ra <- matrix (rep(0,n_org*n_samp), n_org,n_samp)
l_ra <- matrix (rep(0,n_org*n_samp), n_org,n_samp)
clr <- matrix (rep(0,n_org*n_samp), n_org,n_samp)
gm <- rep(0,n_samp)
c <- rep(0,n_samp)

for (i in 1:n_samp) {
               #calc weight
               c[i] <- 1/total[i]

               for (j in 1:n_org) {
               #transform counts to relative abundance and add small amount and log transform
               ra[j,i] <- (counts[j,i]+c[i])/(total[i]+c[i]*n_org)
               l_ra[j,i] <- log(ra[j,i])
               }
               #calculate gm
               gm[i]=mean(l_ra[ ,i])
               clr[ ,i] <- l_ra[ ,i] - gm[i]
}


#verify this code gives same result as compositions package
ra2=t(ra)
rownames(ra2) = colnames(groups_wide[,-1])
colnames(ra2) = groups_wide$taxa_group
dat= clr(acomp(ra2))
dat[1,]
clr[,1]

test = as.data.frame(ra2)
# explore this set
hist(test$Veillonella);hist(test$Streptococcus);hist(test$Prevotella) ;hist(test$Other)
```